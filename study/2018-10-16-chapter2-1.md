# Chapter 2. Critical Data Structures

## ì‚´í´ë³¼ ë°ì´í„° ìŠ¤íŠ¸ëŸ­ì²˜ë“¤

* `struct sk_buff`: íŒ¨í‚·ì„ ë‹´ëŠ” struct. ìœ ì € ë°ì´í„°ì— ëŒ€í•œ ì •ë³´ (payload)ì™€ í—¤ë”ë¥¼ ë‹´ê¸° ìœ„í•œ ìš©ë„ë¡œ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ë ˆì´ì–´ì—ì„œ ì‚¬ìš©ëœë‹¤. íŠ¹ì • ë ˆì´ì–´ì—ì„œì˜ ì‘ì—…ì„ ë•ê¸° ìœ„í•œ ë¶€ê°€ ì •ë³´ë¥¼ ë‹´ëŠ” ê²½ìš°ë„ ìˆìŒ. ì–´ë–»ê²Œ *ëª¨ë“ * ë ˆì´ì–´ì—ì„œ ì´ structë¥¼ ê³µìœ í•  ìˆ˜ ìˆë„ë¡ ë˜ì–´ìˆëŠ”ì§€ ë°‘ì—ì„œ ì‚´í´ë³¼ ê²ƒì„.

* `struct net_device`: ë„¤íŠ¸ì›Œí¬ ë””ë°”ì´ìŠ¤ë¥¼ ë‚˜íƒ€ë‚´ëŠ” struct. í•˜ë“œì›¨ì–´ì™€ ì†Œí”„íŠ¸ì›¨ì–´ ì„¤ì •ì— ëŒ€í•œ ì •ë³´ë¥¼ ë‹´ê³  ìˆë‹¤. `net_device`ê°€ ì–¸ì œ ì–´ë–»ê²Œ í• ë‹¹ë˜ëŠ”ì§€ ìì„¸íˆ ë³´ë ¤ë©´ Chapter 8 ì°¸ê³ .

ì°¸ê³ ë¡œ ì´ ì±…ì—ì„œëŠ” ì†Œì¼“ì— ëŒ€í•œ ì •ë³´ë¥¼ ë‹´ëŠ” `struct sock`ëŠ” ë‹¤ë£¨ì§€ ì•ŠëŠ”ë‹¤ê³  í•¨.

## struct sk_buff
ë³´ë‚¼/ë°›ì€ íŒ¨í‚·ì˜ í—¤ë”ë¥¼ ë‚˜íƒ€ë‚´ë©° ì •ì˜ëŠ” include/linux/skbuff.hì— ìˆê³ , ì—¬ê¸°ì €ê¸°ì„œ ë‹¤ ì“°ì´ê¸° ìœ„í•œ í° struct.

`struct sk_buff`ëŠ” L2(MAC ë“±), L3(IP), L4(TCP, UDP)ì—ì„œ ì“°ì´ëŠ”ë°, ë ˆì´ì–´ë¥¼ ê±´ë„ˆ ì „ë‹¬ë  ë•Œë§ˆë‹¤ í•„ë“œ ê°’ì´ ì ì ˆíˆ ë³€í™”í•˜ê²Œ ëœë‹¤.

ì´ êµ¬ì¡°ì²´ê°€ L4->L3 ë˜ëŠ” L3->L2ë¡œ ì „ë‹¬ë  ë•Œ ì•Œë§ê²Œ headerë¥¼ appendí•˜ê²Œ ëœë‹¤. êµ¬ì¡°ì²´ì˜ ì•ìª½ì— í”„ë¡œí† ì½œ í—¤ë”ë¥¼ ë‹´ì„ ê³µê°„ì„ ì¶”ê°€í•˜ëŠ” ë³µì¡í•œ ì‘ì—…ì„ í•˜ê¸° ìœ„í•´ì„œ `skb_reserve()` í•¨ìˆ˜(ë‚˜ì¤‘ì— ì„¤ëª…)ë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

ë°˜ëŒ€ë¡œ L2->L3 ë˜ëŠ” L3->L4ë¡œ ì „ë‹¬ë  ë•Œ í•˜ìœ„ ë ˆì´ì–´ì˜ headerëŠ” í•„ìš”ì—†ê²Œ ëœë‹¤. í•˜ì§€ë§Œ ì´ì „ ë ˆì´ì–´ì˜ headerë¥¼ ë²„í¼ì—ì„œ ì—†ì• ê¸°ë³´ë‹¤ëŠ” payloadì˜ ì‹œì‘ì„ ë‚˜íƒ€ë‚´ëŠ” í¬ì¸í„° ê°’ë§Œ ë³€ê²½í•´ì¤Œ.

ì•„ë˜ëŠ” 2.6.12.y ë²„ì „. ì¼ë‹¨ ëŠë‚Œë§Œ ë³´ì‹œê¸¸
```c
struct sk_buff {
	/* These two members must be first. */
	struct sk_buff		*next;
	struct sk_buff		*prev;

	struct sk_buff_head	*list;
	struct sock		*sk;
	struct timeval		stamp;
	struct net_device	*dev;
	struct net_device	*input_dev;
	struct net_device	*real_dev;

	union {
		struct tcphdr	*th;
		struct udphdr	*uh;
		struct icmphdr	*icmph;
		struct igmphdr	*igmph;
		struct iphdr	*ipiph;
		struct ipv6hdr	*ipv6h;
		unsigned char	*raw;
	} h;

	union {
		struct iphdr	*iph;
		struct ipv6hdr	*ipv6h;
		struct arphdr	*arph;
		unsigned char	*raw;
	} nh;

	union {
	  	unsigned char 	*raw;
	} mac;

	struct  dst_entry	*dst;
	struct	sec_path	*sp;

	/*
	 * This is the control buffer. It is free to use for every
	 * layer. Please put your private variables there. If you
	 * want to keep them across layers you have to do a skb_clone()
	 * first. This is owned by whoever has the skb queued ATM.
	 */
	char			cb[40];

	unsigned int		len,
				data_len,
				mac_len,
				csum;
	unsigned char		local_df,
				cloned:1,
				nohdr:1,
				pkt_type,
				ip_summed;
	__u32			priority;
	unsigned short		protocol,
				security;

	void			(*destructor)(struct sk_buff *skb);
#ifdef CONFIG_NETFILTER
	unsigned long		nfmark;
	__u32			nfcache;
	__u32			nfctinfo;
	struct nf_conntrack	*nfct;
#ifdef CONFIG_NETFILTER_DEBUG
	unsigned int		nf_debug;
#endif
#ifdef CONFIG_BRIDGE_NETFILTER
	struct nf_bridge_info	*nf_bridge;
#endif
#endif /* CONFIG_NETFILTER */
#if defined(CONFIG_HIPPI)
	union {
		__u32		ifield;
	} private;
#endif
#ifdef CONFIG_NET_SCHED
	__u32			tc_index;	/* traffic control index */
#ifdef CONFIG_NET_CLS_ACT
	__u32			tc_verd;	/* traffic control verdict */
	__u32			tc_classid;	/* traffic control classid */
#endif
#endif


	/* These elements must be at the end, see alloc_skb() for details.  */
	unsigned int		truesize;
	atomic_t		users;
	unsigned char		*head,
				*data,
				*tail,
				*end;
};
```

### ë„¤íŠ¸ì›Œí‚¹ ì˜µì…˜ê³¼ ì»¤ë„ ìŠ¤íŠ¸ëŸ­ì²˜

`struct sk_buff` ì •ì˜ì˜ ë§ˆì§€ë§‰ ìª½ì„ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¶€ë¶„ì´ ìˆë‹¤

```c
#ifdef CONFIG_NET_SCHED
	__u32			tc_index;	/* traffic control index */
#ifdef CONFIG_NET_CLS_ACT
	__u32			tc_verd;	/* traffic control verdict */
	__u32			tc_classid;	/* traffic control classid */
#endif
#endif
```

`#ifdef CONFIG_NET_SCHED` ~ `#endif` ì‚¬ì´ì— ë‚€ `CONFIG_NET_SCHED`ê°€ ì»´íŒŒì¼íƒ€ì„ì— ì •ì˜ë˜ì–´ ìˆì–´ì•¼ë§Œ ì¶”ê°€ë˜ëŠ” í•„ë“œë¡œ, í•´ë‹¹ ì‹¬ë³¼ì€ QoS and/or fair queueing ì»¤ë„ ì˜µì…˜ì„ ì¼œì•¼ ì •ì˜ëœë‹¤. ì˜ ë³´ë©´ `CONFIG_NET_CLS_ACT`ì— ì“°ì´ëŠ” í•„ë“œê°€ ë„¤ìŠ¤íŒ… ë¼ìˆëŠ”ë°, `CONFIG_NET_SCHED`ì™€ `CONFIG_NET_CLS_ACT`ë¥¼ ë‘˜ ë‹¤ ì¼œì•¼ë§Œ í¬í•¨ëœë‹¤.

ì°¸ê³ : [NET_SCHED â€” QoS and/or fair queueing ì˜µì…˜ì— ëŒ€í•œ ì„¤ëª…](https://www.oreilly.com/library/view/linux-kernel-in/0596100795/re185.html)

ì´ëŸ° ì‹ìœ¼ë¡œ ì˜µì…˜ì„ ì¼°ì„ ë•Œ ì»¤ë„ data structureì˜ ì •ì˜ê°€ ë³€í•˜ëŠ” ê²½ìš°ì—ëŠ” í•´ë‹¹ ì˜µì…˜ì„ ëª¨ë“ˆë¡œ ì»´íŒŒì¼í•  ìˆ˜ ì—†ë‹¤ê³  ë³´ë©´ ëœë‹¤.

ì»¤ë„ ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ë“¤ì— ìˆëŠ” _kconfig_ íŒŒì¼ì„ ë³´ë©´ ì˜µì…˜ë“¤ì„ ì°¾ì•„ë³¼ ìˆ˜ ìˆìŒ.

### `struct sk_buff`ì˜ ë©¤ë²„ ë³€ìˆ˜
ëŸ¬í”„í•˜ê²Œ 4ê°€ì§€ ì¢…ë¥˜ë¡œ ë¶„ë¥˜í•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤.

* Layout - ë°ì´í„° ìŠ¤íŠ¸ëŸ­ì²˜ ê·¸ ìì²´ì˜ êµ¬ì„±ì´ë‚˜ ê²€ìƒ‰ ë“±ì— ì“°ì´ëŠ” í•„ë“œë“¤ì„ ë§í•¨.
* General - íŠ¹ì • ì»¤ë„ ê¸°ëŠ¥ì— ì¢…ì†ì ì´ì§€ ì•Šì€ í•„ë“œë“¤
* Feature-specific
* Management functions


### Layout í•„ë“œ

ì»¤ë„ì€ `sk_buff` êµ¬ì¡°ì²´ë¥¼ doubly-linked listë¡œ ê´€ë¦¬í•œë‹¤. ë”°ë¼ì„œ next elementì™€ prev elementì— ëŒ€í•œ í¬ì¸í„°ê°€ ìˆìŒ.
```c
struct sk_buff *next;
struct sk_buff *prev;
```

ì´ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë¡œ ìš”êµ¬ë˜ëŠ” ê¸°ëŠ¥ì´ ìˆëŠ”ë°, ë¦¬ìŠ¤íŠ¸ ë‚´ì˜ ì–´ë–¤ elementì—ì„œë“  ì´ ë¦¬ìŠ¤íŠ¸ì˜ headë¥¼ ë¹ ë¥´ê²Œ ì°¾ì„ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤ëŠ” ê²ƒì„. ë”°ë¼ì„œ ëª¨ë“  ë…¸ë“œê°€ ë¦¬ìŠ¤íŠ¸ í—¤ë“œë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°ë¥¼ ë“¤ê³  ìˆëŠ”ë‹¤.
```c
struct sk_buff_head *list;
```
ì—¬ê¸°ì„œ `struct sk_buff_head`ë¼ëŠ” êµ¬ì¡°ì²´ê°€ ì¶”ê°€ë¡œ ì“°ì´ê²Œ ë˜ëŠ”ë°, ë¦¬ìŠ¤íŠ¸ì˜ ë§¨ ì•ì— ì‚½ì…ë  dummy elementë¡œ ì“°ì´ëŠ” êµ¬ì¡°ì¸ ë™ì‹œì— ë¦¬ìŠ¤íŠ¸ì— ëŒ€í•œ ì¶”ê°€ì ì¸ ì •ë³´ë¥¼ ë‹´ê³  ìˆìŒ. ì• ë‘ í•„ë“œê°€ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì•ë’¤ë¡œ ì™”ë‹¤ê°”ë‹¤ í•˜ê¸° ìœ„í•œ í•„ë“œë¡œ `sk_buff`ì™€ ê°™ê¸° ë•Œë¬¸ì— ê°™ì€ ë¦¬ìŠ¤íŠ¸ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ê²ƒì„.
```c
struct sk_buff_head {
	/* These two members must be first. */
	struct sk_buff	*next;
	struct sk_buff	*prev;

	__u32		qlen;
	spinlock_t	lock;
};
```

ë¦¬ìŠ¤íŠ¸ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. (ì¶œì²˜: Understanding the Linux Network Internals)  
![the organization of the sk_buff doubly-linked list](https://www.safaribooksonline.com/library/view/understanding-linux-network/0596002556/httpatomoreillycomsourceoreillyimages31845.png)

------

ì´ ë²„í¼ë¥¼ ì†Œìœ í•˜ê³  ìˆëŠ” ì†Œì¼“ì— ëŒ€í•œ í¬ì¸í„°. ë°ì´í„°ê°€ ë¡œì»¬ì—ì„œ ìƒì„±ë˜ëŠ” ìƒí™©ì´ë‚˜, ë¡œì»¬ í”„ë¡œì„¸ìŠ¤ê°€ ë°ì´í„°ë¥¼ ë°›ê³  ìˆëŠ” ìƒí™©ì—ì„œ í•„ìš”í•¨. L4ë ˆì´ì–´ì™€ ìœ ì € ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì†Œì¼“ ì •ë³´ë¥¼ í•„ìš”ë¡œ í•˜ê¸° ë•Œë¬¸. Sourceì™€ destinationì´ ëª¨ë‘ ë¡œì»¬ ë¨¸ì‹ ì´ ì•„ë‹Œ ê²½ìš° NULLë¡œ ì„¸íŒ….
```c
struct sock *sk;
```

---

Main buffer (`head`ê°€ ê°€ë¦¬í‚¤ëŠ” ê²ƒ)ì˜ í¬ê¸°ì™€ fragmentë“¤ì— ìˆëŠ” ë°ì´í„° í¬ê¸°ë¥¼ í•©ì¹œ ê²ƒ. ì´ í¬ê¸°ëŠ” ë ˆì´ì–´ë¥¼ ì›€ì§ì¼ ë•Œë§ˆë‹¤ ë³€í•¨.

```c
unsigned int len;
```

---

`len`ê³¼ ë‹¤ë¥´ê²Œ fragmentë“¤ì— ìˆëŠ” í…Œì´í„° í¬ê¸°ë§Œì„ ë‚˜íƒ€ëƒ„.

```c
unsigned int data_len;
```

---

MAC headerì˜ í¬ê¸°ë¥¼ ë‚˜íƒ€ëƒ„.

```c
unsigned int mac_len;
```

---

`sk_buff` êµ¬ì¡°ì²´ì˜ í¬ê¸°ë¥¼ í¬í•¨í•œ ë²„í¼ì˜ ì´ ì‚¬ì´ì¦ˆë¥¼ ë‚˜íƒ€ëƒ„. `sizeof(struct sk_buff) + len`ë¡œ ì´ˆê¸°í™”ëë‹¤ê°€ `len` ê°’ì´ ë°”ë€Œë©´ ê°™ì´ ë°”ë€œ.

```c
unsigned int truesize;
```

---

ì´ `sk_buff` êµ¬ì¡°ì²´ì— ëŒ€í•œ reference count. ì‹¤ì œ ë°ì´í„°ë¥¼ ë‹´ê³  ìˆëŠ” ë²„í¼ì— ëŒ€í•œ reference countëŠ” ë³„ê°œë¡œ ìˆìŒ. `atomic_inc` `atomic_dec` í•¨ìˆ˜ë¥¼ í†µí•´ ì§ì ‘ increment/decrementí•  ìˆ˜ë„ ìˆì§€ë§Œ ëŒ€ë¶€ë¶„ì˜ ê²½ìš° `skb_get` and `kfree_skb`ë¥¼ í†µí•´ ì¡°ì‘.

```c
atomic_t users;
```

---

ê° ë ˆì´ì–´ì—ì„œì˜ ì‘ì—…ì„ ìœ„í•œ ë²„í¼ í• ë‹¹ì„ í•  ë•Œ, ì•ë’¤ë¡œ í—¤ë” ë˜ëŠ” ì¶”ê°€ ë°ì´í„°ë¥¼ ìœ„í•œ ê³µê°„ì„ ë‚¨ê²¨ë†“ëŠ”ë‹¤. `head`ì™€ `end`ëŠ” í• ë‹¹ëœ ê³µê°„ ì‹œì‘ê³¼ ëì„ ê°€ë¦¬í‚¤ê³ , `data`ì™€ `tail`ì€ ì‹¤ì œ ë°ì´í„°ì˜ ì‹œì‘ê³¼ ëì„ ê°€ë¦¬í‚´.

```c
unsigned char *head;
unsigned char *data;
unsigned char *tail;
unsigned char *end;
```

ë‹¤ìŒê³¼ ê°™ì€ ê·¸ë¦¼ìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŒ (ì¶œì²˜: Understanding the Linux Network Internals)  

![head/end versus data/tail pointers](https://www.safaribooksonline.com/library/view/understanding-linux-network/0596002556/httpatomoreillycomsourceoreillyimages31847.png)

---

ë²„í¼ê°€ í•´ì œë  ë•Œ ì‹¤í–‰í•  ë£¨í‹´. ë²„í¼ê°€ ì†Œì¼“ê³¼ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš° ì´ í•„ë“œëŠ” ì´ˆê¸°í™”ë˜ì§€ ì•ŠëŠ”ë‹¤. ì†Œì¼“ì— ì—°ê²°ëœ ê²½ìš°, `sock_rfree` ë˜ëŠ” `sock_wfree`ë¡œ ì´ˆê¸°í™”ë˜ëŠ”ë°, ì†Œì¼“ì´ ì–¼ë§ˆë§Œí¼ì˜ ë©”ëª¨ë¦¬ë¥¼ ì¡ì•„ë¨¹ê³  ìˆëŠ”ì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë™ì‘ì„ í•¨.

```c
void (*destructor)(struct sk_buff *skb);
```

---

### General í•„ë“œ

ë³´í†µ ìˆ˜ì‹ í•œ íŒ¨í‚·ì— ëŒ€í•´ì„œë§Œ ì˜ë¯¸ê°€ ìˆëŠ” íƒ€ì„ ìŠ¤íƒ¬í”„. ê°€ë” ë³´ë‚´ëŠ” íŒ¨í‚·ì— ëŒ€í•´ ì–¸ì œ ì†¡ì¶œí•  ê²ƒì¸ì§€ë¥¼ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ ì“°ì´ê¸°ë„ í•¨.
```c
struct timeval stamp
```

---

`struct net_device`ëŠ” ë„¤íŠ¸ì›Œí¬ ë””ë°”ì´ìŠ¤ë¥¼ ë‚˜íƒ€ë‚´ë©° ì±…ì— ë‚˜ì¤‘ì— ìì„¸íˆ ë‚˜ì˜´. `dev` í•„ë“œëŠ” íŒ¨í‚·ì„ ë°›ì€ ìƒí™©ì—ì„  ì–´ë–¤ ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ë¡œë¶€í„° íŒ¨í‚·ì„ ë°›ì•˜ëŠ”ì§€ë¥¼ ë‚˜íƒ€ë‚´ê³ , íŒ¨í‚·ì„ ë³´ë‚´ëŠ” ìƒí™©ì—ì„  íŒ¨í‚·ì„ ë‚´ë³´ë‚¼ ì¥ì¹˜ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

ì—¬ëŸ¬ í•˜ë“œì›¨ì–´ ì¥ì¹˜ê°€ ëª¨ì—¬ì„œ í•˜ë‚˜ì˜ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ì»¤ë„ ê¸°ëŠ¥ë„ ìˆëŠ”ë°, ì´ëŸ° ê²½ìš° íŒ¨í‚·ì„ ë‚´ë³´ë‚¼ ë•Œì—ëŠ” `dev` í•„ë“œëŠ” ê°€ìƒ ì¥ì¹˜ë¥¼ ê°€ë¦¬í‚¤ê³  ìˆê³ , device driverê°€ ì‹¤ì œ ë¬¼ë¦¬ ì¥ì¹˜ë¥¼ ì„ íƒí•˜ì—¬ `dev` í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•œë‹¤. ë”°ë¼ì„œ íŒ¨í‚· ì²˜ë¦¬ ê³¼ì •ì—ì„œ `dev` í•„ë“œê°€ ë°”ë€” ìˆ˜ ìˆìŒ.
```c
struct net_device *dev
```

---

íŒ¨í‚·ì„ ìˆ˜ì‹ í•œ ì¥ì¹˜ë¥¼ ë‚˜íƒ€ë‚´ë©° ë¡œì»¬ì—ì„œ íŒ¨í‚·ì´ ë§Œë“¤ì–´ì§„ ê²½ìš° `NULL`ì„. Traffic Controlì„ ìœ„í•´ ì‚¬ìš©
```c
struct net_device *input_dev
```

---

ê°€ìƒ ì¥ì¹˜ì¸ ê²½ìš°ì—ë§Œ ì˜ë¯¸ê°€ ìˆìœ¼ë©° network bonding, VLAN ì¸í„°í˜ì´ìŠ¤ ë“±ì—ì„œ ì‚¬ìš©.
```c
struct net_device *real_dev
```

---
